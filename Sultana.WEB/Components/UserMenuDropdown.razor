@using Sultana.WEB.Auth
@inject ILoginService LoginService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<div class="user-menu-container">
    <button class="user-menu-btn" @onclick="ToggleDropdown">
        <div class="user-avatar">
            @if (!string.IsNullOrEmpty(UserPhoto))
            {
                <img src="@UserPhoto" alt="Foto de perfil" class="avatar-img" />
            }
            else
            {
                <i class="bi bi-person-circle avatar-icon"></i>
            }
        </div>
        <span class="user-name">@UserName</span>
        <i class="bi bi-chevron-down dropdown-arrow"></i>
    </button>

    @if (IsDropdownOpen)
    {
        <div class="dropdown-menu show">
            <div class="dropdown-header">
                <div class="user-info">
                    @if (!string.IsNullOrEmpty(UserPhoto))
                    {
                        <img src="@UserPhoto" alt="Foto" class="header-avatar" />
                    }
                    else
                    {
                        <i class="bi bi-person-circle header-avatar-icon"></i>
                    }
                    <div>
                        <div class="user-display-name">@UserName</div>
                        <div class="user-email">@UserEmail</div>
                    </div>
                </div>
            </div>

            <div class="dropdown-divider"></div>

            <a href="/profile" class="dropdown-item" @onclick="CloseDropdown">
                <i class="bi bi-gear"></i>
                <span>Configuración</span>
            </a>

            <a href="/account" class="dropdown-item" @onclick="CloseDropdown">
                <i class="bi bi-person"></i>
                <span>Mi Cuenta</span>
            </a>

            <div class="dropdown-divider"></div>

            <button class="dropdown-item logout-item" @onclick="Logout">
                <i class="bi bi-box-arrow-right"></i>
                <span>Cerrar Sesión</span>
            </button>
        </div>
    }
</div>

@code {
    private bool IsDropdownOpen = false;
    private string? UserName { get; set; }
    private string? UserEmail { get; set; }
    private string? UserPhoto { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfo();
    }

    private async Task LoadUserInfo()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            UserName = user.FindFirst("Nombre")?.Value ?? user.Identity.Name;
            UserEmail = user.Identity.Name;
            UserPhoto = user.FindFirst("Photo")?.Value;
        }
    }

    private void ToggleDropdown()
    {
        IsDropdownOpen = !IsDropdownOpen;
    }

    private void CloseDropdown()
    {
        IsDropdownOpen = false;
    }

    private async Task Logout()
    {
        IsDropdownOpen = false;
        await LoginService.LogoutAsync();
        Navigation.NavigateTo("/", forceLoad: true);
    }

    // Cerrar dropdown al hacer clic fuera
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            // JavaScript interop para cerrar al hacer clic fuera
        }
    }
}