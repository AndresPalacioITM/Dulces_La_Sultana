@page "/Empleado/cmp/EditarConsumo/{Id:long}"
@using Sultana.Shared.Entities
@using CurrieTechnologies.Razor.SweetAlert2
@inject IRepository repository
@inject NavigationManager nav
@inject SweetAlertService sweetAlertService

<PageTitle>Editar Consumo de Materia Prima</PageTitle>

<style>
    /* COPIA TODO EL CSS DE ARRIBA AQUÍ */
</style>

<div class="editar-consumo-page">
    <!-- Encabezado -->
    <div class="consumo-header text-center mb-4">
        <h1 class="consumo-title">Editar Consumo de Materia Prima</h1>
        <p class="consumo-subtitle">Modifica los datos del consumo registrado.</p>
    </div>

    @if (cargando)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-sultana" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando consumo...</p>
        </div>
    }
    else if (consumo == null)
    {
        <div class="alert alert-danger text-center">
            <i class="bi bi-exclamation-triangle me-2"></i>
            No se encontró el consumo solicitado.
        </div>
        <div class="text-center">
            <button class="btn btn-sultana-primary" @onclick="VolverAGestion">
                <i class="bi bi-arrow-left me-2"></i>
                Volver a la gestión
            </button>
        </div>
    }
    else
    {
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card editar-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-pencil-square me-2"></i>
                            Editando Consumo <span class="consumo-id-badge">#@consumo.Id</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <EditForm Model="@consumo" OnValidSubmit="ActualizarConsumo">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="validation-summary" />

                            <!-- Paso 1: Identificación -->
                            <div class="form-step">
                                <h6 class="form-step-title">
                                    <i class="bi bi-tag me-2"></i>Identificación del consumo
                                </h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Orden de Producción</label>
                                        <InputNumber class="form-control" @bind-Value="consumo.OrdenProduccionId" />
                                        <ValidationMessage For="@(() => consumo.OrdenProduccionId)" class="validation-message" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Lote Materia Prima</label>
                                        <InputNumber class="form-control" @bind-Value="consumo.LoteMateriaPrimaId" />
                                        <ValidationMessage For="@(() => consumo.LoteMateriaPrimaId)" class="validation-message" />
                                    </div>
                                </div>
                            </div>

                            <!-- Paso 2: Responsable y Cantidad -->
                            <div class="form-step">
                                <h6 class="form-step-title">
                                    <i class="bi bi-person-check me-2"></i>Responsable y cantidad
                                </h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Responsable ID</label>
                                        <InputNumber class="form-control" @bind-Value="consumo.ResponsableId" />
                                        <ValidationMessage For="@(() => consumo.ResponsableId)" class="validation-message" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Cantidad (kg)</label>
                                        <InputNumber class="form-control" @bind-Value="consumo.CantidadUsada" />
                                        <ValidationMessage For="@(() => consumo.CantidadUsada)" class="validation-message" />
                                    </div>
                                </div>
                            </div>

                            <!-- Paso 3: Fecha -->
                            <div class="form-step">
                                <h6 class="form-step-title">
                                    <i class="bi bi-calendar-event me-2"></i>Momento del consumo
                                </h6>
                                <div class="mb-3">
                                    <label class="form-label">Fecha y Hora</label>
                                    <InputDate class="form-control" @bind-Value="consumo.FechaHora" />
                                    <ValidationMessage For="@(() => consumo.FechaHora)" class="validation-message" />
                                </div>
                            </div>

                            <!-- Botones de acción -->
                            <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                                <button type="button" class="btn btn-sultana-secondary" @onclick="VolverAGestion">
                                    <i class="bi bi-arrow-left me-2"></i>
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-sultana-primary">
                                    <i class="bi bi-check-circle me-2"></i>
                                    Actualizar Consumo
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public long Id { get; set; }
    private ConsumoMP? consumo;
    private bool cargando = true;

    protected override async Task OnInitializedAsync()
    {
        await CargarConsumo();
    }

    private async Task CargarConsumo()
    {
        cargando = true;
        StateHasChanged();

        try
        {
            var response = await repository.GetAsync<ConsumoMP>($"api/ConsumoMP/{Id}");
            if (!response.Error)
            {
                consumo = response.Response;
            }
            else
            {
                var errorMsg = await response.GetErrorMessageAsync();
                await sweetAlertService.FireAsync("Error", errorMsg, SweetAlertIcon.Error);
            }
        }
        catch (Exception ex)
        {
            await sweetAlertService.FireAsync("Error", $"Error al cargar: {ex.Message}", SweetAlertIcon.Error);
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private async Task ActualizarConsumo()
    {
        if (consumo == null) return;

        try
        {
            var response = await repository.PutAsync($"api/ConsumoMP/{Id}", consumo);
            if (!response.Error)
            {
                await sweetAlertService.FireAsync("Éxito", "Consumo actualizado correctamente", SweetAlertIcon.Success);
                VolverAGestion();
            }
            else
            {
                var errorMsg = await response.GetErrorMessageAsync();
                await sweetAlertService.FireAsync("Error", errorMsg, SweetAlertIcon.Error);
            }
        }
        catch (Exception ex)
        {
            await sweetAlertService.FireAsync("Error", $"Error al actualizar: {ex.Message}", SweetAlertIcon.Error);
        }
    }

    private void VolverAGestion()
    {
        nav.NavigateTo("/Empleado/cmp/Consumos");
    }
}