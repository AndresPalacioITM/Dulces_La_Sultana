@page "/Register"

@using Sultana.Shared.DTOs
@using Sultana.WEB.Repositories
@using CurrieTechnologies.Razor.SweetAlert2

@inject IRepository repository
@inject SweetAlertService sweetAlertService
@inject NavigationManager navigationManager

<h3 class="mb-3">Registrar nuevo empleado</h3>

<EditForm Model="userDTO" OnValidSubmit="CreateUserAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-person-plus-fill me-2"></i>Nuevo empleado</span>
            <button class="btn btn-sm btn-primary" type="submit" disabled="@loading">
                @if (loading)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                }
                Registrar
            </button>
        </div>

        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <!-- Nombre -->
                    <div>
                        <label class="form-label">Nombre del empleado</label>
                        <InputText class="form-control" @bind-Value="userDTO.Nombre" />
                        <ValidationMessage For="@(() => userDTO.Nombre)" />
                    </div>

                    <!-- Cargo -->
                    <div>
                        <label class="form-label">Cargo</label>
                        <InputText class="form-control" @bind-Value="userDTO.Cargo" />
                        <ValidationMessage For="@(() => userDTO.Cargo)" />
                    </div>

                    <!-- Contacto -->
                    <div>
                        <label class="form-label">Contacto</label>
                        <InputText class="form-control" @bind-Value="userDTO.Contacto" />
                        <ValidationMessage For="@(() => userDTO.Contacto)" />
                    </div>

                    <!-- Email -->
                    <div>
                        <label class="form-label">Correo</label>
                        <InputText class="form-control" type="email" @bind-Value="userDTO.Email" />
                        <ValidationMessage For="@(() => userDTO.Email)" />
                    </div>
                </div>

                <div class="col-md-6">
                    <!-- Foto (opcional) -->
                    <div>
                        <label class="form-label">Foto (URL/Base64) <span class="text-muted">(opcional)</span></label>
                        <InputText class="form-control" @bind-Value="userDTO.Photo" />
                    </div>

                    <!-- Password -->
                    <div>
                        <label class="form-label">Contraseña</label>
                        <InputText class="form-control" type="password" @bind-Value="userDTO.Password" />
                        <ValidationMessage For="@(() => userDTO.Password)" />
                    </div>

                    <!-- Confirmación -->
                    <div>
                        <label class="form-label">Confirmación de contraseña</label>
                        <InputText class="form-control" type="password" @bind-Value="userDTO.PasswordConfirm" />
                        <ValidationMessage For="@(() => userDTO.PasswordConfirm)" />
                    </div>
                </div>
            </div>
        </div>

        <div class="card-footer bg-white">
            <a class="btn btn-outline-secondary" href="/">Cancelar</a>
        </div>
    </div>
</EditForm>

@code {
    private UserDTO userDTO = new();
    private bool loading;

    private async Task CreateUserAsync()
    {
        try
        {
            loading = true;

            // Si tu AccountsController devuelve token, podrías usar PostAsync<UserDTO, TokenDTO>.
            // Aquí asumimos que basta con crear y luego ir a /Login.
            var response = await repository.PostAsync<UserDTO>("/api/accounts/CreateUser", userDTO);

            if (response.Error)
            {
                var message = await response.GetErrorMessageAsync();
                await sweetAlertService.FireAsync("Error", message, SweetAlertIcon.Error);
                return;
            }

            await sweetAlertService.FireAsync("Confirmación",
                "La cuenta ha sido creada con éxito. Ahora puedes iniciar sesión.",
                SweetAlertIcon.Success);

            navigationManager.NavigateTo("/Login");
        }
        catch (Exception ex)
        {
            await sweetAlertService.FireAsync("Error inesperado", ex.Message, SweetAlertIcon.Error);
        }
        finally
        {
            loading = false;
        }
    }
}
